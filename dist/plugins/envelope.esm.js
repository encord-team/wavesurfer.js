class t{constructor(){this.listeners={}}on(t,i,e){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(i),null==e?void 0:e.once){const e=()=>{this.un(t,e),this.un(t,i)};return this.on(t,e),e}return()=>this.un(t,i)}un(t,i){var e;null===(e=this.listeners[t])||void 0===e||e.delete(i)}once(t,i){return this.on(t,i,{once:!0})}unAll(){this.listeners={}}emit(t,...i){this.listeners[t]&&this.listeners[t].forEach((t=>t(...i)))}}class i extends t{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}_init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((t=>t()))}}function e(t,i,e,o,s,n=3,r=0,l=100){if(!t)return()=>{};matchMedia("(pointer: coarse)").matches;const h=t=>{t.button===r&&(t.preventDefault(),t.stopPropagation(),t.clientX,t.clientY,t.clientX)};return t.addEventListener("pointerdown",h),()=>{t.removeEventListener("pointerdown",h)}}function o(t,i){const e=i.xmlns?document.createElementNS(i.xmlns,t):document.createElement(t);for(const[t,s]of Object.entries(i))if("children"===t&&s)for(const[t,i]of Object.entries(s))i instanceof Node?e.appendChild(i):"string"==typeof i?e.appendChild(document.createTextNode(i)):e.appendChild(o(t,i));else"style"===t?Object.assign(e.style,s):"textContent"===t?e.textContent=s:e.setAttribute(t,s.toString());return e}function s(t,i,e){const s=o(t,i||{});return null==e||e.appendChild(s),s}const n={points:[],lineWidth:4,lineColor:"rgba(0, 0, 255, 0.5)",dragPointSize:10,dragPointFill:"rgba(255, 255, 255, 0.8)",dragPointStroke:"rgba(255, 255, 255, 0.8)"};class r extends t{constructor(t,i){super(),this.subscriptions=[],this.subscriptions=[],this.options=t,this.polyPoints=new Map;const o=i.clientWidth,n=i.clientHeight,r=s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"100%",height:"100%",viewBox:`0 0 ${o} ${n}`,preserveAspectRatio:"none",style:{position:"absolute",left:"0",top:"0",zIndex:"4"},part:"envelope"},i);this.svg=r;const l=s("polyline",{xmlns:"http://www.w3.org/2000/svg",points:`0,${n} ${o},${n}`,stroke:t.lineColor,"stroke-width":t.lineWidth,fill:"none",part:"polyline",style:t.dragLine?{cursor:"row-resize",pointerEvents:"stroke"}:{}},r);t.dragLine&&this.subscriptions.push(e(l)),r.addEventListener("dblclick",(t=>{const i=r.getBoundingClientRect(),e=t.clientX-i.left,o=t.clientY-i.top;this.emit("point-create",e/i.width,o/i.height)}));{let t;const i=()=>clearTimeout(t);r.addEventListener("touchstart",(e=>{1===e.touches.length?t=window.setTimeout((()=>{e.preventDefault();const t=r.getBoundingClientRect(),i=e.touches[0].clientX-t.left,o=e.touches[0].clientY-t.top;this.emit("point-create",i/t.width,o/t.height)}),500):i()})),r.addEventListener("touchmove",i),r.addEventListener("touchend",i)}}makeDraggable(t,i){this.subscriptions.push(e(t,0,0,0,0,1))}createCircle(t,i){const e=this.options.dragPointSize/2;return s("ellipse",{xmlns:"http://www.w3.org/2000/svg",cx:t,cy:i,rx:e,ry:e,fill:this.options.dragPointFill,stroke:this.options.dragPointStroke,"stroke-width":"2",style:{cursor:"grab",pointerEvents:"all"},part:"envelope-circle"},this.svg)}removePolyPoint(t){const i=this.polyPoints.get(t);if(!i)return;const{polyPoint:e,circle:o}=i,{points:s}=this.svg.querySelector("polyline"),n=Array.from(s).findIndex((t=>t.x===e.x&&t.y===e.y));s.removeItem(n),o.remove(),this.polyPoints.delete(t)}addPolyPoint(t,i,e){const{svg:o}=this,{width:s,height:n}=o.viewBox.baseVal,r=t*s,l=n-i*n,h=this.options.dragPointSize/2,a=o.createSVGPoint();a.x=t*s,a.y=n-i*n;const u=this.createCircle(r,l),{points:d}=o.querySelector("polyline"),c=Array.from(d).findIndex((t=>t.x>=r));d.insertItemBefore(a,Math.max(c,1)),this.polyPoints.set(e,{polyPoint:a,circle:u}),this.makeDraggable(u,((t,i)=>{const o=a.x+t,r=a.y+i;if(o<-h||r<-h||o>s+h||r>n+h)return void this.emit("point-dragout",e);const l=Array.from(d).find((t=>t.x>a.x)),c=Array.from(d).findLast((t=>t.x<a.x));l&&o>=l.x||c&&o<=c.x||(a.x=o,a.y=r,u.setAttribute("cx",o.toString()),u.setAttribute("cy",r.toString()),this.emit("point-move",e,o/s,r/n))}))}update(){const{svg:t}=this,i=t.viewBox.baseVal.width/t.clientWidth,e=t.viewBox.baseVal.height/t.clientHeight;t.querySelectorAll("ellipse").forEach((t=>{const o=this.options.dragPointSize/2,s=o*i,n=o*e;t.setAttribute("rx",s.toString()),t.setAttribute("ry",n.toString())}))}destroy(){this.subscriptions.forEach((t=>t())),this.polyPoints.clear(),this.svg.remove()}}class l extends i{constructor(t){super(t),this.polyline=null,this.throttleTimeout=null,this.volume=1,this.points=t.points||[],this.options=Object.assign({},n,t),this.options.lineColor=this.options.lineColor||n.lineColor,this.options.dragPointFill=this.options.dragPointFill||n.dragPointFill,this.options.dragPointStroke=this.options.dragPointStroke||n.dragPointStroke,this.options.dragPointSize=this.options.dragPointSize||n.dragPointSize}static create(t){return new l(t)}addPoint(t){var i;t.id||(t.id=Math.random().toString(36).slice(2));const e=this.points.findLastIndex((i=>i.time<t.time));this.points.splice(e+1,0,t),this.emitPoints();const o=null===(i=this.wavesurfer)||void 0===i?void 0:i.getDuration();o&&this.addPolyPoint(t,o)}removePoint(t){var i;const e=this.points.indexOf(t);e>-1&&(this.points.splice(e,1),null===(i=this.polyline)||void 0===i||i.removePolyPoint(t),this.emitPoints())}getPoints(){return this.points}setPoints(t){this.points.slice().forEach((t=>this.removePoint(t))),t.forEach((t=>this.addPoint(t)))}destroy(){var t;null===(t=this.polyline)||void 0===t||t.destroy(),super.destroy()}getCurrentVolume(){return this.volume}setVolume(t){var i;this.volume=t,null===(i=this.wavesurfer)||void 0===i||i.setVolume(t)}onInit(){var t;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");const{options:i}=this;i.volume=null!==(t=i.volume)&&void 0!==t?t:this.wavesurfer.getVolume(),this.setVolume(i.volume),this.subscriptions.push(this.wavesurfer.on("decode",(t=>{this.initPolyline(),this.points.forEach((i=>{this.addPolyPoint(i,t)}))})),this.wavesurfer.on("redraw",(()=>{var t;null===(t=this.polyline)||void 0===t||t.update()})),this.wavesurfer.on("timeupdate",(t=>{this.onTimeUpdate(t)})))}emitPoints(){this.throttleTimeout&&clearTimeout(this.throttleTimeout),this.throttleTimeout=setTimeout((()=>{this.emit("points-change",this.points)}),200)}initPolyline(){if(this.polyline&&this.polyline.destroy(),!this.wavesurfer)return;const t=this.wavesurfer.getWrapper();this.polyline=new r(this.options,t),this.subscriptions.push(this.polyline.on("point-move",((t,i,e)=>{var o;const s=(null===(o=this.wavesurfer)||void 0===o?void 0:o.getDuration())||0;t.time=i*s,t.volume=1-e,this.emitPoints()})),this.polyline.on("point-dragout",(t=>{this.removePoint(t)})),this.polyline.on("point-create",((t,i)=>{var e;this.addPoint({time:t*((null===(e=this.wavesurfer)||void 0===e?void 0:e.getDuration())||0),volume:1-i})})),this.polyline.on("line-move",(t=>{var i;this.points.forEach((i=>{i.volume=Math.min(1,Math.max(0,i.volume-t))})),this.emitPoints(),this.onTimeUpdate((null===(i=this.wavesurfer)||void 0===i?void 0:i.getCurrentTime())||0)})))}addPolyPoint(t,i){var e;null===(e=this.polyline)||void 0===e||e.addPolyPoint(t.time/i,t.volume,t)}onTimeUpdate(t){if(!this.wavesurfer)return;let i=this.points.find((i=>i.time>t));i||(i={time:this.wavesurfer.getDuration()||0,volume:0});let e=this.points.findLast((i=>i.time<=t));e||(e={time:0,volume:0});const o=i.time-e.time,s=i.volume-e.volume,n=e.volume+(t-e.time)*(s/o),r=Math.min(1,Math.max(0,n)),l=Math.round(100*r)/100;l!==this.getCurrentVolume()&&(this.setVolume(l),this.emit("volume-change",l))}}export{l as default};
